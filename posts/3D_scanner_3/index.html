<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="[3D scanner] 3D scanner 제작기 - 3" /><meta property="og:locale" content="ko" /><meta name="description" content="관련 포스팅 [3D scanner] 3D scanner 제작기 - 1 [3D scanner] 3D scanner 제작기 - 2" /><meta property="og:description" content="관련 포스팅 [3D scanner] 3D scanner 제작기 - 1 [3D scanner] 3D scanner 제작기 - 2" /><link rel="canonical" href="https://isornorphism.github.io/posts/3D_scanner_3/" /><meta property="og:url" content="https://isornorphism.github.io/posts/3D_scanner_3/" /><meta property="og:site_name" content="Isomorphism!" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-04-09T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[3D scanner] 3D scanner 제작기 - 3" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-09T00:00:00+09:00","datePublished":"2023-04-09T00:00:00+09:00","description":"관련 포스팅 [3D scanner] 3D scanner 제작기 - 1 [3D scanner] 3D scanner 제작기 - 2","headline":"[3D scanner] 3D scanner 제작기 - 3","mainEntityOfPage":{"@type":"WebPage","@id":"https://isornorphism.github.io/posts/3D_scanner_3/"},"url":"https://isornorphism.github.io/posts/3D_scanner_3/"}</script><title>[3D scanner] 3D scanner 제작기 - 3 | Isomorphism!</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Isomorphism!"><meta name="application-name" content="Isomorphism!"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Isomorphism!</a></div><div class="site-subtitle" style="letter-spacing: -0.02em;">다채로운 vectorspace를 span할 수 있도록<br> orthogonal basis를 만드는 곳입니다.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/CV/" class="nav-link"> <i class="fa-fw fas fa-file ml-xl-3 mr-xl-3 unloaded"></i> <span>CV</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Isornorphism" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sgheong','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[3D scanner] 3D scanner 제작기 - 3</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[3D scanner] 3D scanner 제작기 - 3</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/Isornorphism">Gwanhyeong Song</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2023-04-09 00:00:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Sun, Apr 9, 2023, 12:00 AM +0900" >Apr 9</em> </span> <span> Updated <em class="timeago" date="2023-04-09" data-toggle="tooltip" data-placement="bottom" title="Sun, Apr 9, 2023, 12:00 AM +0000" >Apr 9</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3805 words"> <em>21 min</em> read</span></div></div></div><div class="post-content"><blockquote><p><em>관련 포스팅</em></p><ul><li><a href="https://isornorphism.github.io/posts/3D_scanner_1/">[3D scanner] 3D scanner 제작기 - 1</a><li><a href="https://isornorphism.github.io/posts/3D_scanner_2/">[3D scanner] 3D scanner 제작기 - 2</a></ul></blockquote><p><br /></p><h2 id="4-소프트웨어-개발-과정">4. 소프트웨어 개발 과정 <a href="#4-소프트웨어-개발-과정" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="41-문제점-및-해결-과정">4.1 문제점 및 해결 과정 <a href="#41-문제점-및-해결-과정" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>소프트웨어 개발 중 맞닥뜨린 문제점과 그 해결 과정을 위주로 서술하였습니다.</p><h4 id="411-ir-거리-센서와-레이저-tof-거리-센서-비교">4.1.1 IR 거리 센서와 레이저 TOF 거리 센서 비교 <a href="#411-ir-거리-센서와-레이저-tof-거리-센서-비교" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><div class="table-wrapper"><table><thead><tr><th>구분<th>GP2Y0A21YK0F IR 센서<th>VL5310X Laser TOF 센서<tbody><tr><td>통신<td>아날로그 전압 신호<td>I2C<tr><td>제어핀<td>아날로그 입력 핀<td>A4(SCL), A5(SDA)<tr><td>측정 원리<td>적외선이 물체에서 반사된 지점에 따라 <br /> 수신부에 도달하는 지점의 차이를 이용해 측정<td>레이저 빛이 발사되고 물체에 반사되어 <br /> 수신될 때까지 시간을 측정</table></div><p>VL5310X 레이저 TOF 거리 센서 역시 10000원 대의 저렴한 가격으로 구매할 수 있는 거리 측정 센서입니다. 두 센서 중 어느 센서를 사용할지 결정하기 위해 사진과 같은 멀티미터를 한 slice 스캔하여 그 결과를 비교해 보았습니다. 별도의 데이터 후처리는 수행하지 않았습니다.</p><p><img data-src="/assets/img/3D_scanner/Fig_22_c.jpg" alt="Multimeter_image" width="70%" data-proofer-ignore> <em>Multimeter with edge</em></p><p><img data-src="/assets/img/3D_scanner/Fig_22_a.png" alt="IR_sensor_result" width="60%" data-proofer-ignore> <em>Scan result w/ IR sensor</em></p><p><img data-src="/assets/img/3D_scanner/Fig_22_b.png" alt="Laser_TOF_sensor_result" width="70%" data-proofer-ignore> <em>Scan result w/ Laser TOF sensor</em></p><p>IR 거리 센서 측정 결과를 보면 적외선의 입사각이 10도보다 작은 네 부분에서 규칙적으로 펄스가 관찰되었습니다. 반면 레이저 TOF 거리 센서의 측정 결과에서는 전체적인 정밀도는 높지만, 몸체가 얇게 왜곡되었습니다.</p><p>실험 결과 멀티미터의 주황색 케이스 부분의 엣지 부분이 원인으로 파악되었습니다. 직진성이 강한 레이저의 특성 상, 물체 표면의 방향이 레이저와 수직을 이루지 못할 경우 다른 곳으로 반사되므로 불규칙한 형상을 스캔할 시 정밀도가 크게 하락하였습니다.</p><p>이러한 제약을 감수할 수는 없으므로, 본 3D scanner 프로젝트에서는 IR 거리 센서를 사용하였습니다. 원래 레이저 TOF 거리 센서의 측정 범위는 2m 임을 생각하면 3mm 남짓의 오차는 센서 가격 대비 작은 편에 속하므로 이 센서는 추후에 자작 Lidar 프로젝트 때 사용해볼 계획입니다.</p><p><br /></p><h4 id="412-ir-거리-센서의-측정-오차-원인-분석">4.1.2 IR 거리 센서의 측정 오차 원인 분석 <a href="#412-ir-거리-센서의-측정-오차-원인-분석" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>IR 거리 센서를 사용하기로 결심했지만, 발견된 오차를 무시할 수는 없습니다. 규칙적으로 발생하는 펄스를 좀 더 정량적으로 측정하기 위해 rotating plate 위에 회전축을 지나는 평면을 붙인 다음 180도 스캔하여 입사각에 따른 오차를 측정해보았습니다. 그 결과 다음과 같이 도출되었습니다.</p><p><img data-src="/assets/img/3D_scanner/Fig_23.png" alt="Error_plot" width="70%" data-proofer-ignore> <em>Incidence angle vs IR sensor distance error</em></p><p>이제 예상 오차 가설과 검증 과정을 정리해봅시다. 이 과정이 정말 오래 걸렸고 저에게 극심한 스트레스를 주었지만, 사실 결과는 허무하게 끝났습니다…</p><h5 id="1-회전-중심에서-거리에-따른-지점의-선속도-차이">1) 회전 중심에서 거리에 따른 지점의 선속도 차이 <a href="#1-회전-중심에서-거리에-따른-지점의-선속도-차이" class="anchor"><i class="fas fa-hashtag"></i></a></h5></h5><p>회전 중심에서 먼 지점일수록 선속도가 커지므로 잔상 효과를 크게 받게 됩니다. 가장 먼저 떠올린 가설이었지만, 물체의 회전 방향을 바꾸어 측정하여도 펄스의 방향은 유지되었기 때문에 본 가설은 기각되었습니다.</p><h5 id="2-ir-거리-센서의-방향과-회전-중심-사이의-편심">2) IR 거리 센서의 방향과 회전 중심 사이의 편심 <a href="#2-ir-거리-센서의-방향과-회전-중심-사이의-편심" class="anchor"><i class="fas fa-hashtag"></i></a></h5></h5><p><img data-src="/assets/img/3D_scanner/Fig_24.jpg" alt="Eccentric_model" width="50%" data-proofer-ignore> <em>Eccentric model of IR distance sensor</em></p><p>센서랑 모터 조립 시 오차가 발생하여 IR 거리 센서와 회전 중심 사이에 편심이 발생할 가능성이 존재합니다. 이를 이론적으로 분석해봅시다. 위의 그림과 같이 원래 빨간색으로 표시한 평면을 파란색으로 표시한 회전 중심을 지나는 센서로 측정해야하지만, 편심 s가 발생한 노란색 센서로 측정했다고 가정해봅시다.</p><p>빨간색으로 표시한 직선의 방정식은 극좌표계에서 다음과 같이 기술할 수 있습니다.</p>\[r(\theta) = \frac{d}{\cos{\theta}}\]<p>편심 $s$가 있는 센서로 평면을 스캔할 때의 측정 결과를 $r’(\theta)$라 합시다. 노란색 삼각형과 초록색으로 표시한 각도 $\phi$를 보면 다음이 성립합니다.</p>\[\begin{align*} \sin{\phi} &amp;= \frac{s}{r(\theta - \phi)} \\ &amp;= \frac{s}{d} \cos{(\theta - \phi)} \\ &amp;= \frac{s}{d} (\cos{\theta} \cos{\phi} + \sin{\theta} \sin{\phi}) \end{align*}\] \[1 = \frac{s}{d} \left( \frac{\cos{\theta}}{\tan{\phi}} + \sin{\theta} \right)\] \[\therefore \tan{\phi} = \frac{s \cos{\theta}}{d - s \sin {\theta}}\]<p>따라서 $r’(\theta)$는 다음과 같이 유도됩니다.</p>\[\tan{\phi} = \frac{s}{r'(\theta)} = \frac{s \cos{\theta}}{d - s \sin{\theta}}\] \[\therefore r'(\theta) = \frac{d - s \sin{\theta}}{\cos{\theta}}\]<p><img data-src="/assets/img/3D_scanner/Fig_25.png" alt="Eccentric_model_plot" width="60%" data-proofer-ignore> <em>Eccentric model plot</em></p><p>위 그래프에서 빨간색 그래프는 원래 평면, 초록색 그래프는 편심 모델에 따라 왜곡된 측정 결과를 나타냅니다. 편심 수치를 과장하여 $d=20mm$, $s=5mm$를 대입하였음에도 불구하고 펄스를 닮지 않은걸 확인할 수 있습니다. 따라서 본 가설 역시 기각되었습니다.</p><h5 id="3-센서와-표면-재질에-따른-고유-특성">3) 센서와 표면 재질에 따른 고유 특성 <a href="#3-센서와-표면-재질에-따른-고유-특성" class="anchor"><i class="fas fa-hashtag"></i></a></h5></h5><p>다른 가설은 없을지 머리를 싸매고 며칠간 고민했지만, 뾰족한 생각이 들지 않았습니다. 물체를 바꾸어가며 측정해보았지만 재질에 따라 정도의 차이만 있을 뿐 규칙적으로 펄스가 발생하였기 때문입니다. 결국 GP2Y0A21YK0F IR 센서의 고유한 특성으로 인정하였습니다. 이하 내용부터는 거리 센서의 오차를 입사각 $\phi_{inc}$에 대한 함수 $e(\phi_{inc})$로 두어 수치적인 모델로 해결하는 과정을 서술하였습니다.</p><p><br /></p><h4 id="413-ir-거리-센서의-측정-오차-해결-과정">4.1.3 IR 거리 센서의 측정 오차 해결 과정 <a href="#413-ir-거리-센서의-측정-오차-해결-과정" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><h5 id="1-오차-모델-수립-및-모델-기반-해결">1) 오차 모델 수립 및 모델 기반 해결 <a href="#1-오차-모델-수립-및-모델-기반-해결" class="anchor"><i class="fas fa-hashtag"></i></a></h5></h5><p><img data-src="/assets/img/3D_scanner/Fig_26.png" alt="Incidence_angle_derivation" width="70%" data-proofer-ignore> <em>Incidence angle in ploar coordinate</em></p><p>물체의 실제 표면을 $r(\theta)$라고 하면, 거리 벡터( $\vec{r} = \vec{OP}$ )와 물체의 표면이 이루는 각도 $\frac{\pi}{2} - \phi_{inc}$는 다음과 같이 구할 수 있습니다.</p>\[\tan{ \left( \frac {\pi}{2} - {\phi}_{inc} \right) } = \frac{r(\theta)}{\frac{\partial r}{\partial \theta} (\theta)}\] \[\phi_{inc} = \frac{\pi}{2} - \rm{atan2} \left( r(\theta), \frac{\partial r}{\partial \theta}(\theta) \right)\]<p>따라서 오차 모델을 다음과 같이 수립할 수 있습니다.</p>\[\begin{align*} r'(\theta) &amp;= r(\theta) + e \left( \frac{\pi}{2} - \rm{atan2} \left( r(\theta), \frac{\partial r}{\partial \theta}(\theta) \right) \right) \\ &amp;= r(\theta) + f \left( \theta; r, \frac{\partial r}{\partial \theta} \right) \end{align*}\]<p>이는 주어진 $f$와 측정한 $r’(\theta)$를 바탕으로 $r(\theta)$를 찾는 전형적인 inverse problem입니다. 그러나 오차 함수가 비선형 함수이고, 함수 $f$가 $r, \frac{\partial r}{\partial \theta}$에 동시에 의존하기 때문에 이를 풀기는 쉽지 않습니다. 저 역시 이를 해결할 수치적인 방법을 고안하지 못하였기 때문에, 아쉽게도 모델 기반 해결책은 기각하였습니다.</p><h5 id="2-모델-프리-해결">2) 모델 프리 해결 <a href="#2-모델-프리-해결" class="anchor"><i class="fas fa-hashtag"></i></a></h5></h5><p>결국 외부 소프트웨어의 도움을 빌렸습니다. “Meshlab”이라는 오픈 소스 3D mesh 툴을 이용하여 pointcloud를 mesh로 변환한 다음, 적용할 수 있는 surface smoothing 알고리즘을 비교하였습니다. 그 결과, <strong>Laplace smoothing</strong> 알고리즘이 가장 적절하게 펄스 노이즈를 제거하는걸 확인했습니다. Meshlab 프로그램과 Laplace smoothing에 대한 설명은 다음을 참고하시면 좋을 것 같습니다.</p><blockquote><p>참고 자료</p><ul><li><a href="https://www.meshlab.net/">MeshLab</a><li><a href="https://people.eecs.berkeley.edu/~jrs/meshpapers/Sorkine.pdf">Laplacian mesh processing</a></ul></blockquote><p><br /></p><h4 id="414-sram-메모리-부족-문제-및-해결">4.1.4 SRAM 메모리 부족 문제 및 해결 <a href="#414-sram-메모리-부족-문제-및-해결" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>아두이노 UNO를 사용하기로 결심한 후 메모리 용량이 부족하지 않을까 고민했는데… 걱정이 현실이 되었습니다. 개발 후반후에 접어들면서 아두이노 IDE 상에서 메모리 부족 경고가 뜨더니 결국 컴파일해도 작동을 하지 않더라고요. 아두이노 UNO의 SRAM 용량은 2048Bytes밖에 되지 않기 때문에 항상 주의를 기울여야 합니다. 저는 다음과 같은 해결책을 적용하여 이러한 문제를 해결할 수 있었습니다.</p><ul><li>Hyperparameter의 경우 <code class="language-plaintext highlighter-rouge">PROGMEM</code> 명령어를 사용하여 flash 메모리에 데이터를 저장합니다. 대표적으로 속도와 정밀도 세팅값, LCD에 출력할 custom character가 있습니다.<li>문자열을 함수의 인수로 대입할 시 <code class="language-plaintext highlighter-rouge">F()</code> macro를 사용하여 flash 메모리에 저장합니다.<li>변수의 범위를 고려하여 알맞은 변수 type를 선택합니다. 예를 들어 속도나 해상도 세팅은 3~4가지가 있으므로 <code class="language-plaintext highlighter-rouge">byte</code> 변수로 저장하고, flag 변수는 0, 1만 가지므로 <code class="language-plaintext highlighter-rouge">bool</code>, z slices 값은 기하학적으로 1000 이하이기 때문에 <code class="language-plaintext highlighter-rouge">uint16_t</code>로 저장합니다.<li>아두이노 IDE에서 지역 변수가 사용하는 메모리는 추적하지 못하기 때문에 메모리 사용량을 가늠하기 쉽도록 지역 변수를 최소화하였습니다. 또한 일부 변수는 재사용하였습니다.</ul><blockquote><p>참고 자료</p><ul><li><a href="https://www.arduino.cc/reference/en/language/variables/utilities/progmem/">PROGMEM, F() macro</a></ul></blockquote><p><br /></p><h3 id="42-class-설명">4.2 class 설명 <a href="#42-class-설명" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>각 class별 역할과 기능을 설명합니다.</p><h4 id="421-hyperparameterh">4.2.1 hyperparameter.h <a href="#421-hyperparameterh" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>NEMA17의 한 회전 당 스텝 수 200, A4988에 설정해둔 분주 수 16, IR 거리 센서에서 plate 중심까지 거리 158mm 등 3D scanner 기본 세팅 값이 저장되어있습니다. <code class="language-plaintext highlighter-rouge">PROGMEM</code>을 이용하여 flash 메모리에 저장하는 테크닉이 여기에 많이 적용되었습니다.</p><h4 id="422-lcdh--lcdcpp">4.2.2 lcd.h &amp; lcd.cpp <a href="#422-lcdh--lcdcpp" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>아두이노 LCD I2C 모듈을 제어하는 라이브러리 <code class="language-plaintext highlighter-rouge">LiquidCrystal_I2C</code>를 상속하여 작성하였습니다. 특정 줄의 문장을 스크롤하는 <code class="language-plaintext highlighter-rouge">custom_scroll()</code>와 막대 그래프를 출력하는 <code class="language-plaintext highlighter-rouge">bar_graph()</code>, 아두이노 flash 메모리에 저장된 특수 문자를 불러오는 <code class="language-plaintext highlighter-rouge">createChar_P()</code> 함수가 구현되어 있습니다.</p><h4 id="423-a4988_stepperh--a4988_steppercpp">4.2.3 A4988_stepper.h &amp; A4988_stepper.cpp <a href="#423-a4988_stepperh--a4988_steppercpp" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>A4988 모터 드라이버로 스텝 모터를 제어하는 클래스입니다. A4988은 pulse의 duration을 통해 모터의 속도를 조절하는데, 이러한 duration을 설정하는 <code class="language-plaintext highlighter-rouge">set_period()</code> 함수가 구현되어 있습니다. 또한 모터의 방향을 조절하는 <code class="language-plaintext highlighter-rouge">set_dir()</code>, 입력한 스텝만큼 회전하는 <code class="language-plaintext highlighter-rouge">rotate_step()</code> 등의 함수가 구현되어 있습니다.</p><h4 id="424-buttonh--buttoncpp">4.2.4 button.h &amp; button.cpp <a href="#424-buttonh--buttoncpp" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>Rotary encoder의 버튼과 limit switch를 제어하는 클래스입니다. 버튼이 눌렸는지 확인하는 <code class="language-plaintext highlighter-rouge">is_pushed()</code> 함수와 버튼이 한 번 클릭되었는지 더블 클릭되었는지 판단하는 <code class="language-plaintext highlighter-rouge">is_singled_or_double_ clicked()</code> 함수가 구현되어 있습니다.</p><h4 id="425-distance_sensorh--distance_sensorcpp">4.2.5 distance_sensor.h &amp; distance_sensor.cpp <a href="#425-distance_sensorh--distance_sensorcpp" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>Sharp 사의 GP2Y0A21YK0F IR 거리 센서로 측정한 거리를 mm 단위로 반환하는 <code class="language-plaintext highlighter-rouge">get_distance()</code> 함수가 구현되어 있습니다. 거리 측정 시 정밀도를 향상하기 위해 5회 측정한 평균값을 반환합니다.</p><p><br /></p><h3 id="43-3d-scanning-흐름도">4.3 3D scanning 흐름도 <a href="#43-3d-scanning-흐름도" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><img data-src="/assets/img/3D_scanner/Fig_3.png" alt="3D_scanning_flow_chart" width="60%" data-proofer-ignore> <em>3D scanning flow chart</em></p><p>각 단계는 rotary encoder 버튼을 1번 클릭 시 다음으로 넘어갈 수 있고, 더블 클릭 시 이전 화면으로 되돌아갑니다. LCD 화면을 통해 세팅 화면을 출력합니다.</p><h4 id="431-시작-화면">4.3.1 시작 화면 <a href="#431-시작-화면" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>SD 카드를 장착했는지 확인합니다. 확인은 5초마다 수행됩니다. SD 카드가 장착되어 있는 채로 버튼을 클릭하면 다음 화면으로 이동합니다.</p><h4 id="432-모터-속도-세팅">4.3.2 모터 속도 세팅 <a href="#432-모터-속도-세팅" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>Rotating plate의 회전 속도를 결정합니다. 회전 속도가 빨라질 시 전체 scanning 시간은 감소하지만, IR 거리 센서로 물체의 표면을 스캔할 때 잔상 효과가 발생하고 물체의 진동이 커져 정확도가 감소합니다. Rotary encoder를 시계, 반시계 방향으로 회전하여 SLOW, MEDIUM, FAST, VERY FAST 4 단계로 조절할 수 있습니다.</p><h4 id="433-θ-해상도-세팅">4.3.3 θ-해상도 세팅 <a href="#433-θ-해상도-세팅" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>한 회전에 측정하는 점의 수를 결정합니다. LOW, MEDIUM, HIGH 3단계로 조절할 수 있으며, LOW의 경우 100pts/rev, MEDIUM은 200pts/rev, HIGH는 400pts/rev의 해상도로 스캔합니다.</p><h4 id="434-z-해상도-세팅">4.3.4 z-해상도 세팅 <a href="#434-z-해상도-세팅" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>물체를 스캔하는 z 방향 간격을 결정합니다. LOW, MEDIUM, HIGH 3단계로 조절할 수 있으며, LOW의 경우 3mm 간격, MEDIUM은 2mm 간격, HIGH는 1mm 간격으로 스캔합니다.</p><h4 id="435-원점-세팅">4.3.5 원점 세팅 <a href="#435-원점-세팅" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>거리 센서 carriage를 limit switch 위치까지 내렸다가 사용자가 z=0으로 둘 높이를 설정하는 단계입니다. Rotary encoder를 시계, 반시계 방향으로 돌려 z=0 위치를 조절할 수 있습니다.</p><h4 id="436-물체-확인">4.3.6 물체 확인 <a href="#436-물체-확인" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>물체를 plate 위에 올렸는지 확인하는 단계입니다.</p><h4 id="437-pre-scanning">4.3.7 Pre-scanning <a href="#437-pre-scanning" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>사용자가 설정한 z=0 지점부터 물체의 최고점까지 높이를 측정하여 z-slices 개수를 계산합니다. 거리 센서 carriage를 z=0부터 일정 거리만큼 올리면서 측정값과 미리 정해둔 최대 거리값을 비교합니다. 최대 거리값보다 작게 측정될 경우 물체가 존재한다는 의미이므로 다시 carriage를 1 slice 상승시킵니다. 최대 거리값보다 크게 측정될 경우 이 각도에는 물체가 없지만 다른 각도에는 물체가 존재할 수 있으므로 plate를 1바퀴 회전하면서 계속 비교를 수행합니다. 모든 각도에서 물체가 존재하지 않다고 판단될 경우 pre-scanning을 종료하고 z-slices 개수를 LCD에 출력합니다. 이는 scanning 단계에서 진행도를 계산하는데 사용됩니다.</p><h4 id="438-scanning">4.3.8 Scanning <a href="#438-scanning" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>스캔을 시작하기 전에 SD 카드가 슬롯에 있는지 다시 한번 확인하고, SD 카드가 존재하지 않으면 시작 화면으로 돌아갑니다. SD 카드가 정상적으로 존재할 경우 SD 카드의 “(root 폴더에 있는 파일 개수)+1.txt”의 이름으로 파일을 만들고 스캔한 점의 좌표를 기록합니다. 스캔 과정에서, 스캔을 완료한 z-slices 개수와 전체 z-slices 개수로부터 진행도를 계산하여 LCD에 막대 그래프로 출력합니다. 스캔이 완료되면 파일 쓰기를 종료하고 시작 화면으로 돌아갑니다.</p><h4 id="439-데이터-후처리">4.3.9 데이터 후처리 <a href="#439-데이터-후처리" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>Python open3d 라이브러리를 사용하여 pointcloud 데이터를 시각화할 수 있습니다. Meshlab 프로그램을 사용하여 pointcloud를 mesh로 변환할 수 있습니다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/making/'>Making</a>, <a href='/categories/3d-scanner/'>3D scanner</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/3d-scanner/" class="post-tag no-text-decoration" >3D scanner</a> <a href="/tags/software/" class="post-tag no-text-decoration" >software</a> <a href="/tags/tof/" class="post-tag no-text-decoration" >TOF</a> <a href="/tags/laser/" class="post-tag no-text-decoration" >laser</a> <a href="/tags/eccentric/" class="post-tag no-text-decoration" >eccentric</a> <a href="/tags/laplace-smoothing/" class="post-tag no-text-decoration" >Laplace smoothing</a> <a href="/tags/meshlab/" class="post-tag no-text-decoration" >meshlab</a> <a href="/tags/progmem/" class="post-tag no-text-decoration" >PROGMEM</a> <a href="/tags/f-macro/" class="post-tag no-text-decoration" >F() macro</a> <a href="/tags/flow-chart/" class="post-tag no-text-decoration" >flow chart</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[3D scanner] 3D scanner 제작기 - 3 - Isomorphism!&url=https://isornorphism.github.io/posts/3D_scanner_3/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[3D scanner] 3D scanner 제작기 - 3 - Isomorphism!&u=https://isornorphism.github.io/posts/3D_scanner_3/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://isornorphism.github.io/posts/3D_scanner_3/&text=[3D scanner] 3D scanner 제작기 - 3 - Isomorphism!" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/IR_light_2/">[IR light] 전등 리모컨 제작기 - 2</a><li><a href="/posts/IR_light_3/">[IR light] 전등 리모컨 제작기 - 3</a><li><a href="/posts/IR_light_1/">[IR light] 전등 리모컨 제작기 - 1</a><li><a href="/posts/3D_scanner_4/">[3D scanner] 3D scanner 제작기 - 4</a><li><a href="/posts/3D_scanner_3/">[3D scanner] 3D scanner 제작기 - 3</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/3d-scanner/">3D scanner</a> <a class="post-tag" href="/tags/ir-light/">IR light</a> <a class="post-tag" href="/tags/solidworks/">Solidworks</a> <a class="post-tag" href="/tags/discriminator/">discriminator</a> <a class="post-tag" href="/tags/exponential/">exponential</a> <a class="post-tag" href="/tags/gan/">gan</a> <a class="post-tag" href="/tags/generative-model/">generative model</a> <a class="post-tag" href="/tags/generator/">generator</a> <a class="post-tag" href="/tags/hardware/">hardware</a> <a class="post-tag" href="/tags/levenberg/">Levenberg</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/3D_scanner_1/"><div class="card-body"> <em class="timeago small" date="2023-04-07 00:00:00 +0900" >Apr 7</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[3D scanner] 3D scanner 제작기 - 1</h3><div class="text-muted small"><p> 6월에 군대 입대가 예정되어있어 휴학 중에 있습니다. 며칠 동안은 자유를 만끽했지만 이내 몸이 근질거리더라고요. 무슨 일을 벌일까 고민을 하다가, 저를 기계공학부로 오도록 만들어준 making을 오랜만에 해보기로 했습니다. 초, 중학교 때 취미 삼아서 과학상자, 아두이노 등을 많이 하면서 기계/로봇공학자가 되고 싶다라고 꿈을 꿔왔거든요. 이번...</p></div></div></a></div><div class="card"> <a href="/posts/3D_scanner_2/"><div class="card-body"> <em class="timeago small" date="2023-04-08 00:00:00 +0900" >Apr 8</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[3D scanner] 3D scanner 제작기 - 2</h3><div class="text-muted small"><p> 관련 포스팅 [3D scanner] 3D scanner 제작기 - 1 3. 전자 회로 제작 과정 3.1 개발 보드 선택 구분 Arduino UNO Raspberry Pi 4 언어 C++ Python ...</p></div></div></a></div><div class="card"> <a href="/posts/3D_scanner_4/"><div class="card-body"> <em class="timeago small" date="2023-04-12 00:00:00 +0900" >Apr 12</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[3D scanner] 3D scanner 제작기 - 4</h3><div class="text-muted small"><p> 관련 포스팅 [3D scanner] 3D scanner 제작기 - 1 [3D scanner] 3D scanner 제작기 - 2 [3D scanner] 3D scanner 제작기 - 3 5. 결과 5.1 전체 시스템 소개 3D scanner image 3D scanner operating diagra...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/3D_scanner_2/" class="btn btn-outline-primary" prompt="Older"><p>[3D scanner] 3D scanner 제작기 - 2</p></a> <a href="/posts/3D_scanner_4/" class="btn btn-outline-primary" prompt="Newer"><p>[3D scanner] 3D scanner 제작기 - 4</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/Isornorphism">Gwanhyeong Song</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/3d-scanner/">3D scanner</a> <a class="post-tag" href="/tags/ir-light/">IR light</a> <a class="post-tag" href="/tags/solidworks/">Solidworks</a> <a class="post-tag" href="/tags/discriminator/">discriminator</a> <a class="post-tag" href="/tags/exponential/">exponential</a> <a class="post-tag" href="/tags/gan/">gan</a> <a class="post-tag" href="/tags/generative-model/">generative model</a> <a class="post-tag" href="/tags/generator/">generator</a> <a class="post-tag" href="/tags/hardware/">hardware</a> <a class="post-tag" href="/tags/levenberg/">Levenberg</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
